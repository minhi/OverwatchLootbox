<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Lootbox opening</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <link href="css/style.css" rel="stylesheet">
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.3/velocity.min.js"></script>
        <script src="https://cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>
    </head>
    <body>
        <main>
            <div id="user-container" class="user-container">
                <!-- Hier kommen die User per JS rein -->
            </div>

            <div id="i"></div>
            <div>
                <input id="input" type="text" name="input" value="username" />
                <button id="btn">button</button>
            </div>
            <div class="clickbtn-container">
                <button id="click" class="clickbtn">Click</button>
            </div>
        </main>
        <script>
            ////// VARIABLEN /////
            var socket = io();
            var myUsername = "";
            var myId = -1;
            var timer; // scorebouncing
            var TIMEOUT = 200; // ms

            ////// CONTROLLER /////
            // Anmeldung
            $("#btn").click(function() {
                 var input = $("#input").val();
                 socket.emit("add", input);
            });

            // Buttonaktionen
            $("#click").mousedown(function() {
                $("#click").addClass("down");
                $("#click").text(myUsername);
                $("#i").text("down ");
                socket.emit("down", myUsername);
                $("#click").mouseleave(function() {
                    $("#i").text("up ");
                    $("#click").off("mouseleave");
                    socket.emit("up", myId);
                });
            });

            $("#click").mouseup(function() {
                $("#click").off("mouseleave");
                $("#i").text("up ");
                socket.emit("up", myId);
            });
            
            ////// SOCKET.IO LISTENER //////

            // Beim connecten schonmal die User im Raum laden
            socket.on("build", function(msg) {
                // Beachte, dass wir eine Liste aus Usern haben als msg
                for (i = 0; i < msg.length; ++i) {
                    addNewUser(msg[i].id, msg[i].username);
                }
            });

            // Neuer User hat sich eingeloggt
            // msg: {username, id, socketid}
            socket.on("add", function(msg) {
                addNewUser(msg.id, msg.username);
            });

            // Das gleiche wie add, bloß dass id und username gespeichert werden
            // Nach dem Anmelden, die ID und Username speichern
            socket.on("bind", function(msg) {
                addNewUser(msg.id, msg.username);
                myId = msg.id;
                myUsername = msg.username;
            });

            // Entferne einen User
            socket.on("remove", function(msg) {
                removeUserById(msg.id);
            });

            // Buttonverhalten
            socket.on("down", function(username) {
                $("#click").text(username);
                $("#click").addClass("down");
            });

            // Update score
            socket.on("up", function(userScore) {
                // msg enthält {id, score}
                var $score = $("#user-" + userScore.id + " .score");
                $score.velocity("stop");
                var seq = [
                    {e: $score, p: {scale: 1.5}, o: {duration: 50}},
                    {e: $score, p: {scale: 1.0}, o: {duration: 50, delay: 25}}
                ]
                $.Velocity.RunSequence(seq);
                $score.text(userScore.score);
                $("#click").removeClass("down");
            });

            ////// HILFSFUNKTIONEN //////

            // Fügt einen neuen User hinzu (auf View-Ebene)
            function addNewUser(id, username) {
                var $new = $("<div/>", {id: "user-" + id, class: "user-item"});
                $("<div/>", {class: "username", text: username}).appendTo($new);
                $("<div/>", {class: "score", text: 0}).appendTo($new);
                $("#user-container").append($new);
                $("#user-" + id).velocity("fadeIn", {duration: 300, easing: "easeInOutSine"});
            }

            // Entfernt einen User (auf View-Ebene)
            function removeUserById(id) {
                $user = $("#user-" + id);
                // Animation abspielen und danach Element entfernen
                $user.velocity("fadeOut", {duration: 300, easing: "easeInOutSine", complete: function(elements) {
                    $("#user-" + id).remove();
                }});
            }

        </script>
    </body>
</html>